##This code first starts with full hourly data for 2001 to 2020 Dec 15-Feb 15.
##Then, it filters to return only daylight hours, when Furcifer pardalis is potentially active
##Due to memory limitations, this code is run in batches and dataframes are saved as .csv, 
##then read in and appended together at the end.
##The daylight hours subset is then used to estimate activity and preference.

###Activity
#We use the min and max data for thermal preference collected in lab trials to generate an activity window
#Using this range, we filter through the hours on the spreadsheet for active temperatures "yes" and inactive temperatures "no"
#We then count number of active/inactive per day,
#then average # yes's per day per winter period (daily average winter activity window


####IN PROGRESS####
###Performance data
#extract best performance values from trials. Note the scale (lowest- highest)
#calculate the best performance and 50% from that... #% can change
#fit a model/equation to the curve 
#use the equation to get a performance value by inputting a temperature value
#apply the equation to all the hourly data for each pixel
#count the # hours available at the maximal and within 50% performance level
#average # hours per day per winter period (daily average winter performance availability)
#average the daily possible performance values (maybe not the best approach)




#filter out hours that are below sunrise and above sunset
#install.packages("dtplyr")
library(dtplyr)
library(data.table)
library(tidyr)
library(dplyr)


####Take all the hourly data, filter for daylight hours, then append together in one table
d1<-fread("Full Hourly Data/year0103df220012.csv")
d2<-fread("Full Hourly Data/year0103df220022.csv")
d3<-fread("Full Hourly Data/year0103df220032.csv")
d4<-fread("Full Hourly Data/year0406df220042.csv")
d5<-fread("Full Hourly Data/year0406df220052.csv")
d6<-fread("Full Hourly Data/year0607df220062.csv")
d7<-fread("Full Hourly Data/year20074Nat.csv")
d8<-fread("Full Hourly Data/year2008to20134NC/year0809df220082.csv")
d9<-fread("Full Hourly Data/year2008to20134NC/year0809df220092.csv")
d10<-fread("Full Hourly Data/year2008to20134NC/year1011df220102.csv")

### do the daylight sorting in 2 batches of 10 to save memory.


d11<-fread("Full Hourly Data/year2008to20134NC/year1011df220112.csv")
d12<-fread("Full Hourly Data/year2008to20134NC/year1213df220122.csv")
d13<-fread("Full Hourly Data/year2008to20134NC/year1213df220132.csv")
d14<-fread("Full Hourly Data/year2014to20204NC/year1415df220142.csv")
d15<-fread("Full Hourly Data/year2014to20204NC/year1415df220152.csv")
d16<-fread("Full Hourly Data/year2014to20204NC/year1617df220162.csv")
d17<-fread("Full Hourly Data/year2014to20204NC/year1617df220172.csv")
d18<-fread("Full Hourly Data/year2014to20204NC/year1819df220182.csv")
d19<-fread("Full Hourly Data/year2014to20204NC/year1819df220192.csv")
d20<-fread("Full Hourly Data/year2014to20204NC/year2020df220202.csv")


##where the hourtemps dataframe is long format hourly temperatures for each pixel, YMD
##needs to have the sunrise/sunset columns!

#apply this code to every d# above, append to the allday dataframe.
d2<-d2%>%
  filter(Hour>Sunrise)%>%
  filter(Hour<Sunset)

d2<-as_tibble(d2)

d1<-d1%>%
  filter(Hour>Sunrise)%>%
  filter(Hour<Sunset)

d1<-as_tibble(d1)

allday<-rbind(allday, d20)
unique(allday$Date)

#d19<-0 #reassign names as 0 once finished to save memory without clearing environment completely.

#ftable(allday)
str(allday)
# as ftable, then fwrite
#fwrite(allday, "Full Hourly Data/11to20.csv")


unique(allday$Date)


####Generate activity window from Tpref data####
pref<-read.csv("C:/Users/nmcla/Dropbox/2PhysioHerpInvasives_Shared/Data/chameleons/thermal preference/thermal_pref_summary_merged.csv") #adjust to your local directory
#filter out diseased/dying animals
pref<-filter(pref,notes_pref!="moribund")
mean(pref$min_prefbody_temp)
min(pref$min_prefbody_temp)

mean(pref$max_prefbody_temp)
max(pref$max_prefbody_temp)
###using averages our window is 27.072 to 37.168, let's use 27 to 37###
#minimum in gradient is 21.9 max is 40.6








###Read in the data thresholded by daylight hours

d1<-fread("Full Hourly Data/01to10.csv")
#do process with first decade, then second, then append.

###probably have to run code separately for each 10 year batch, memory issue.

####apply activity threshold to climate data####
##it is possible that 27 to 37 is too restricted
d1$active_smallwindow<-ifelse(d1$Temp <= 27, "no",
                       ifelse(d1$Temp >=37,"no", "yes"))

#d1<-fread("Full Hourly Data/01to10.csv")
d1<-fread("Full Hourly Data/11to20.csv")

#this is a larger window for all temps measured in gradient 22-40.5
#use this in analyses
d1$active_lrgwindow<-ifelse(d1$Temp <= 22, "no",
                                   ifelse(d1$Temp >=40.5,"no", "yes"))

#count number of yes per day
d1sum <- d1 %>%
  group_by(x2,y2,Year,Month,Day)%>%
  count(active_lrgwindow, name= "nhours")

d1sum<-as_tibble(d1sum)

####There are many instances where all hours are active ("yes") or inactive ("no") variables for a pixel and date.

###This code adds "yes" and "0" where they are missing
nos<-d1sum%>%
  filter(active_lrgwindow=="no")%>%
  filter(nhours==11)
nos<-as_tibble(nos)
nhours11_new <-replace(nos, 7,0)
nhours11_new <-replace(nhours11_new, 6,"yes")
d1_zeroes_added <-rbind(d1sum,nhours11_new)

#Then, add "no" and "0" where they are missing
yess<-d1sum%>%
  filter(active_lrgwindow=="yes")%>%
  filter(nhours==11)
yess<-as_tibble(yess)
nhours11_new <-replace(yess, 7,0)
nhours11_new <-replace(nhours11_new, 6,"no")
d1_zeroes_added <-rbind(d1_zeroes_added,nhours11_new)

#write the end product to a csv
#fwrite(d1_zeroes_added, "Full Hourly Data/11to20activesummary.csv")

#APPEND THE 2 DECADES TOGETHER HERE
d1<-fread("Full Hourly Data/01to10activesummary.csv")
d2<-fread("Full Hourly Data/11to20activesummary.csv")
alldata<-rbind(d1,d2)

###calculate active hours

#average hours per pixel per day active or not across ENTIRE winter period
avg_activity<-aggregate(list(nhours=alldata$nhours), by=list(x=alldata$x2, y=alldata$y2, Category=alldata$active_lrgwindow), FUN=mean) 

#this outputs mean # daylight hours inactive (no) and active (yes)

#then calculate the % of active daylight hours per winter period per pixel.
percactive<-avg_activity%>%
  group_by(x,y)%>%
  mutate(perc= ifelse(Category=="yes", 100*(nhours[Category=="yes"]/(nhours[Category=="yes"]+nhours[Category=="no"])), NA))%>%
  drop_na(perc)

#fwrite(percactive, "Full Hourly Data/01to20activitysummary.csv")
#this final dataframe gives both average daylight active hours and % active daylight hours

###now to convert to a raster!!###
activity<-fread("Full Hourly Data/01to20activitysummary.csv")

###convert the average hours per pixel back into a raster#
library(raster)
coordinates(activity)<- ~x+y

#read in already-cropped FL raster to copy extent
r<-raster("Thresholded_daily_temps/9C/PanChemT9L6.tif")
activity_nhours_raster<-rasterize(activity[,1:2], r, activity$nhours)
activity_percent_raster<-rasterize(activity[,1:2], r, activity$perc)

plot(activity_nhours_raster)
plot(activity_percent_raster)

#writeRaster(activity_nhours_raster, paste0(names(activity_nhours_raster),"activity_nhours_raster.tif"), bylayer=TRUE, format="GTiff")
#writeRaster(activity_percent_raster, paste0(names(activity_percent_raster),"activity_percent_raster.tif"), bylayer=TRUE, format="GTiff")







